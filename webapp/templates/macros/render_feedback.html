{% macro render_feedback(unit, exercise, is_feedback_box, result, feedback_message, your_answer, user_answer, incorrect_question, current_user, force_full_bookmark, bookmark_id) %}

    {% if is_feedback_box and result %}
        {% if result == 'correct' %}
            <div class='feedback-correct-container'>
                <p class="correct">Correct</p>
                {% if feedback_message %}
                    <p class="feedback-message">{{ feedback_message | safe }}</p>
                {% endif %}

                <div class="flag-form-container">
                    <button type="button"
                            class="flag-button"
                            title="Flag this answer as having an error"
                            onclick="toggleFlagForm(this)">
                        &#127987;
                    </button>

                    <form action="{{ url_for('routes.flag_question', unit=unit, exercise=exercise) }}"
                          method="post"
                          class="flag-form hidden">

                        <input type="hidden" name="feedback_message" value="{{ feedback_message }}">
                        <input type="hidden" name="user_answer" value="{{ user_answer }}">
                        <input type="hidden" name="result" value="{{ 'Correct' if result == 'correct' else 'Incorrect' }}">

                        <textarea name="reason"
                                  rows="3"
                                  placeholder="Reason for flagging"
                                  required></textarea>

                        <button type="submit">Enter</button>
                    </form>
                </div>

        {% if current_user.is_authenticated and feedback_message %}
          <form method="post"
                action="{{ url_for('routes.toggle_bookmark') }}"
                class="bookmark-form">

            {# If bookmark_id is provided (bookmarks page), use it #}
            {% if bookmark_id is defined %}
              <input type="hidden" name="bookmark_id" value="{{ bookmark_id }}">
            {% else %}
              {# exercise page: keep the old fields #}
              <input type="hidden" name="unit" value="{{ unit }}">
              <input type="hidden" name="exercise" value="{{ exercise }}">
              <input type="hidden" name="level" value="{{ level }}">
              <input type="hidden" name="result" value="{{ result }}">
              <input type="hidden" name="user_answer" value="{{ user_answer }}">
              <input type="hidden" name="feedback_message" value="{{ feedback_message }}">
              <input type="hidden" name="next" value="{{ request.path }}">
            {% endif %}

            <button type="submit"
                    class="bookmark-button"
                    aria-label="Toggle bookmark">
              <img
                class="bookmark-icon"
                src="{% if force_full_bookmark or is_bookmarked %}
                        {{ url_for('static', filename='bookmarks/full.png') }}
                     {% else %}
                        {{ url_for('static', filename='bookmarks/empty.png') }}
                     {% endif %}"
                alt="bookmark icon">
            </button>
          </form>
        {% endif %}

            </div>
        {% else %}
            <div class='feedback-incorrect-container'>
                <p class="incorrect">Incorrect</p>
                {% if feedback_message %}
                    <p class="feedback-message">{{ feedback_message | safe }}</p>
                {% endif %}
                <p class="feedback-message">{{ your_answer | safe }} {{ user_answer }} {{ incorrect_question | safe }}</p>

                <div class="flag-form-container">
                    <button type="button"
                            class="flag-button"
                            title="Flag this answer as having an error"
                            onclick="toggleFlagForm(this)">
                        &#127987;
                    </button>

                    <form action="{{ url_for('routes.flag_question', unit=unit, exercise=exercise) }}"
                          method="post"
                          class="flag-form hidden">

                        <input type="hidden" name="feedback_message" value="{{ feedback_message }}">
                        <input type="hidden" name="user_answer" value="{{ user_answer }}">
                        <input type="hidden" name="result" value="{{ 'Correct' if result == 'correct' else 'Incorrect' }}">

                        <textarea name="reason"
                                  rows="3"
                                  placeholder="Reason for flagging"
                                  required></textarea>

                        <button type="submit">Enter</button>
                    </form>
                </div>

                {% if current_user.is_authenticated and feedback_message %}
                <form method="post"
                      action="{{ url_for('routes.toggle_bookmark') }}"
                      class="bookmark-form">
                  <input type="hidden" name="unit" value="{{ unit }}">
                  <input type="hidden" name="exercise" value="{{ exercise }}">
                  <input type="hidden" name="level" value="{{ level }}">
                  <input type="hidden" name="result" value="{{ result }}">
                  <input type="hidden" name="user_answer" value="{{ user_answer }}">
                  <input type="hidden" name="feedback_message" value="{{ feedback_message }}">
                  <input type="hidden" name="next" value="{{ request.path }}">

                    <button type="submit"
                            class="bookmark-button"
                            aria-label="Toggle bookmark">
                      <img
                          class="bookmark-icon"
                          src="{% if force_full_bookmark or is_bookmarked %}
                                  {{ url_for('static', filename='bookmarks/full.png') }}
                               {% else %}
                                  {{ url_for('static', filename='bookmarks/empty.png') }}
                               {% endif %}"
                          alt="bookmark icon">
                    </button>
                </form>
              {% endif %}

            </div>
        {% endif %}
    {% endif %}

{% endmacro %}